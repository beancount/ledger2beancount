#!/usr/bin/perl -w

# Copyright (C) 2016 Stefano Zacchiroli <zack@upsilon.cc>
# License: GNU General Public License (GPL), version 3 or above

# convert a ledger-cli commodities file to beancount format

# TODO

use strict;
use warnings;

use File::BaseDir qw/config_home/;
use Config::Onion;

my @config_files = ('ledger2beancount', config_home('ledger2beancount', 'config'));
my $config;
foreach my $config_file (@config_files) {
    $config = Config::Onion->load($config_file);
    last if defined $config;
}

$config->set_default(commodities_date => "1970-01-01");
$config->set_default(beancount_indent => 2);

$config = $config->get;

sub print_metadata($$) {
    my ($key, $value) = @_;
    print ' ' x $config->{beancount_indent}, lc($key), ": \"$value\"\n";
}

while (my $l = <>) {
    chomp $l;

    if ($l =~ /^commodity\s+(.*)/) {  # account declaration
	print "$config->{commodities_date} commodity $1\n";
    } elsif ($l =~ /^\s+note\s+(.*)/) {  # note
	print_metadata("name", $1);
    } elsif ($l =~ /^\s+format\s+(.*)/) {  # format
	next;  # skip directive, not needed in beancount
    } else {
	print "$l\n";
    }
}
